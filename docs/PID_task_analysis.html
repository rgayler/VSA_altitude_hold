<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Ross Gayler" />

<meta name="date" content="2021-08-20" />

<title>PID Task Analysis</title>

<script src="site_libs/header-attrs-2.10/header-attrs.js"></script>
<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />

<link rel="icon" href="https://github.com/workflowr/workflowr-assets/raw/master/img/reproducible.png">
<!-- Add a small amount of space between sections. -->
<style type="text/css">
div.section {
  padding-top: 12px;
}
</style>



<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>








<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.tab('show');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">VSA_altitude_hold</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="about.html">About</a>
</li>
<li>
  <a href="license.html">License</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/rgayler/VSA_altitude_hold">
    <span class="fa fa-github"></span>
     
    Source code
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">PID Task Analysis</h1>
<h4 class="author">Ross Gayler</h4>
<h4 class="date">2021-08-20</h4>

</div>


<p>
<button type="button" class="btn btn-default btn-workflowr btn-workflowr-report" data-toggle="collapse" data-target="#workflowr-report">
<span class="glyphicon glyphicon-list" aria-hidden="true"></span>
workflowr
<span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span>
</button>
</p>
<div id="workflowr-report" class="collapse">
<ul class="nav nav-tabs">
<li class="active">
<a data-toggle="tab" href="#summary">Summary</a>
</li>
<li>
<a data-toggle="tab" href="#checks">
Checks <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span>
</a>
</li>
<li>
<a data-toggle="tab" href="#versions">Past versions</a>
</li>
</ul>
<div class="tab-content">
<div id="summary" class="tab-pane fade in active">
<p>
<strong>Last updated:</strong> 2021-09-10
</p>
<p>
<strong>Checks:</strong>
<span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span>
7
<span class="glyphicon glyphicon-exclamation-sign text-danger" aria-hidden="true"></span>
0
</p>
<p>
<strong>Knit directory:</strong>
<code>VSA_altitude_hold/</code>
<span class="glyphicon glyphicon-question-sign" aria-hidden="true" title="This is the local directory in which the code in this file was executed.">
</span>
</p>
<p>
This reproducible <a href="http://rmarkdown.rstudio.com">R Markdown</a>
analysis was created with <a
  href="https://github.com/jdblischak/workflowr">workflowr</a> (version
1.6.2). The <em>Checks</em> tab describes the
reproducibility checks that were applied when the results were created.
The <em>Past versions</em> tab lists the development history.
</p>
<hr>
</div>
<div id="checks" class="tab-pane fade">
<div id="workflowr-checks" class="panel-group">
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongRMarkdownfilestronguptodate">
<span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span>
<strong>R Markdown file:</strong> up-to-date
</a>
</p>
</div>
<div id="strongRMarkdownfilestronguptodate" class="panel-collapse collapse">
<div class="panel-body">
<p>Great! Since the R Markdown file has been committed to the Git repository, you
know the exact version of the code that produced these results.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongEnvironmentstrongempty">
<span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span>
<strong>Environment:</strong> empty
</a>
</p>
</div>
<div id="strongEnvironmentstrongempty" class="panel-collapse collapse">
<div class="panel-body">
<p>Great job! The global environment was empty. Objects defined in the global
environment can affect the analysis in your R Markdown file in unknown ways.
For reproduciblity it’s best to always run the code in an empty environment.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongSeedstrongcodesetseed20210617code">
<span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span>
<strong>Seed:</strong> <code>set.seed(20210617)</code>
</a>
</p>
</div>
<div id="strongSeedstrongcodesetseed20210617code" class="panel-collapse collapse">
<div class="panel-body">
<p>The command <code>set.seed(20210617)</code> was run prior to running the code in the R Markdown file.
Setting a seed ensures that any results that rely on randomness, e.g.
subsampling or permutations, are reproducible.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongSessioninformationstrongrecorded">
<span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span>
<strong>Session information:</strong> recorded
</a>
</p>
</div>
<div id="strongSessioninformationstrongrecorded" class="panel-collapse collapse">
<div class="panel-body">
<p>Great job! Recording the operating system, R version, and package versions is
critical for reproducibility.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongCachestrongnone">
<span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span>
<strong>Cache:</strong> none
</a>
</p>
</div>
<div id="strongCachestrongnone" class="panel-collapse collapse">
<div class="panel-body">
<p>Nice! There were no cached chunks for this analysis, so you can be confident
that you successfully produced the results during this run.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongFilepathsstrongrelative">
<span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span>
<strong>File paths:</strong> relative
</a>
</p>
</div>
<div id="strongFilepathsstrongrelative" class="panel-collapse collapse">
<div class="panel-body">
<p>Great job! Using relative paths to the files within your workflowr project
makes it easier to run your code on other machines.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongRepositoryversionstrongahrefhttpsgithubcomrgaylerVSAaltitudeholdtree771869b0ea547c9869e1ec1d4edc5f23bafcc2e6targetblank771869ba">
<span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span>
<strong>Repository version:</strong> <a href="https://github.com/rgayler/VSA_altitude_hold/tree/771869b0ea547c9869e1ec1d4edc5f23bafcc2e6" target="_blank">771869b</a>
</a>
</p>
</div>
<div id="strongRepositoryversionstrongahrefhttpsgithubcomrgaylerVSAaltitudeholdtree771869b0ea547c9869e1ec1d4edc5f23bafcc2e6targetblank771869ba" class="panel-collapse collapse">
<div class="panel-body">
<p>
Great! You are using Git for version control. Tracking code development and
connecting the code version to the results is critical for reproducibility.
</p>
<p>
The results in this page were generated with repository version <a href="https://github.com/rgayler/VSA_altitude_hold/tree/771869b0ea547c9869e1ec1d4edc5f23bafcc2e6" target="_blank">771869b</a>.
See the <em>Past versions</em> tab to see a history of the changes made to the
R Markdown and HTML files.
</p>
<p>
Note that you need to be careful to ensure that all relevant files for the
analysis have been committed to Git prior to generating the results (you can
use <code>wflow_publish</code> or <code>wflow_git_commit</code>). workflowr only
checks the R Markdown file, but you know if there are other scripts or data
files that it depends on. Below is the status of the Git repository when the
results were generated:
</p>
<pre><code>
Ignored files:
    Ignored:    .Rhistory
    Ignored:    .Rproj.user/
    Ignored:    renv/library/
    Ignored:    renv/local/
    Ignored:    renv/staging/

</code></pre>
<p>
Note that any generated files, e.g. HTML, png, CSS, etc., are not included in
this status report because it is ok for generated content to have uncommitted
changes.
</p>
</div>
</div>
</div>
</div>
<hr>
</div>
<div id="versions" class="tab-pane fade">

<p>
These are the previous versions of the repository in which changes were made
to the R Markdown (<code>analysis/PID_task_analysis.Rmd</code>) and HTML (<code>docs/PID_task_analysis.html</code>)
files. If you’ve configured a remote Git repository (see
<code>?wflow_git_remote</code>), click on the hyperlinks in the table below to
view the files as they were in that past version.
</p>
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
File
</th>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
<th>
Message
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/rgayler/VSA_altitude_hold/blob/771869b0ea547c9869e1ec1d4edc5f23bafcc2e6/analysis/PID_task_analysis.Rmd" target="_blank">771869b</a>
</td>
<td>
Ross Gayler
</td>
<td>
2021-09-10
</td>
<td>
WIP
</td>
</tr>
<tr>
<td>
html
</td>
<td>
<a href="https://rawcdn.githack.com/rgayler/VSA_altitude_hold/771869b0ea547c9869e1ec1d4edc5f23bafcc2e6/docs/PID_task_analysis.html" target="_blank">771869b</a>
</td>
<td>
Ross Gayler
</td>
<td>
2021-09-10
</td>
<td>
WIP
</td>
</tr>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/rgayler/VSA_altitude_hold/blob/4d6a44c4d5645e296eed6975d6d5652a4ffc804f/analysis/PID_task_analysis.Rmd" target="_blank">4d6a44c</a>
</td>
<td>
Ross Gayler
</td>
<td>
2021-09-10
</td>
<td>
WIP
</td>
</tr>
<tr>
<td>
html
</td>
<td>
<a href="https://rawcdn.githack.com/rgayler/VSA_altitude_hold/4d6a44c4d5645e296eed6975d6d5652a4ffc804f/docs/PID_task_analysis.html" target="_blank">4d6a44c</a>
</td>
<td>
Ross Gayler
</td>
<td>
2021-09-10
</td>
<td>
WIP
</td>
</tr>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/rgayler/VSA_altitude_hold/blob/bb5f38666d053b04ca16cb2cc1df5cde39eb167f/analysis/PID_task_analysis.Rmd" target="_blank">bb5f386</a>
</td>
<td>
Ross Gayler
</td>
<td>
2021-09-09
</td>
<td>
WIP
</td>
</tr>
<tr>
<td>
html
</td>
<td>
<a href="https://rawcdn.githack.com/rgayler/VSA_altitude_hold/bb5f38666d053b04ca16cb2cc1df5cde39eb167f/docs/PID_task_analysis.html" target="_blank">bb5f386</a>
</td>
<td>
Ross Gayler
</td>
<td>
2021-09-09
</td>
<td>
WIP
</td>
</tr>
<tr>
<td>
html
</td>
<td>
<a href="https://rawcdn.githack.com/rgayler/VSA_altitude_hold/e1e1d253442f62438abdb4eae5c70b6d79e18280/docs/PID_task_analysis.html" target="_blank">e1e1d25</a>
</td>
<td>
Ross Gayler
</td>
<td>
2021-08-20
</td>
<td>
WIP
</td>
</tr>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/rgayler/VSA_altitude_hold/blob/415989a0d28a4493ae36c268f57d0b6c6d6e1a53/analysis/PID_task_analysis.Rmd" target="_blank">415989a</a>
</td>
<td>
Ross Gayler
</td>
<td>
2021-08-20
</td>
<td>
WIP
</td>
</tr>
<tr>
<td>
html
</td>
<td>
<a href="https://rawcdn.githack.com/rgayler/VSA_altitude_hold/415989a0d28a4493ae36c268f57d0b6c6d6e1a53/docs/PID_task_analysis.html" target="_blank">415989a</a>
</td>
<td>
Ross Gayler
</td>
<td>
2021-08-20
</td>
<td>
WIP
</td>
</tr>
<tr>
<td>
html
</td>
<td>
<a href="https://rawcdn.githack.com/rgayler/VSA_altitude_hold/de8dbda9296c45b71b3b0a101fcbdf1ddfe0388e/docs/PID_task_analysis.html" target="_blank">de8dbda</a>
</td>
<td>
Ross Gayler
</td>
<td>
2021-08-18
</td>
<td>
Build site.
</td>
</tr>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/rgayler/VSA_altitude_hold/blob/af002d994f20dbca323cb2bc6dcb0783e32ddda5/analysis/PID_task_analysis.Rmd" target="_blank">af002d9</a>
</td>
<td>
Ross Gayler
</td>
<td>
2021-08-18
</td>
<td>
Add linear spline scalar encoder
</td>
</tr>
</tbody>
</table>
</div>
<hr>
</div>
</div>
</div>
<p>This notebook attempts to statistically characterise the PID controller
as a black-box function.</p>
<p>Looking at the <a href="design_notes.html#dfd-01">data flow diagram for Design
01</a>, and ignoring the tuning parameters, there
are three input variables:</p>
<ul>
<li>Altitude (<span class="math inline">\(z\)</span>)</li>
<li>Vertical velocity (<span class="math inline">\(dz\)</span>)</li>
<li>Target altitude (<span class="math inline">\(k_{tgt}\)</span>)</li>
</ul>
<p>And one output variable:</p>
<ul>
<li>Clipped motor demand (<span class="math inline">\(i8 \triangleq u\)</span>)</li>
</ul>
<p>The integrated error nodes (<span class="math inline">\(i4\)</span>, <span class="math inline">\(i5\)</span>, <span class="math inline">\(i9\)</span>) introduce a history
dependence into the PID function. This part of the DFD implements the
“I” (integral) term of “PID” controller. However, the previous analyses
of the simulation data suggest that the integral term is only effective
in the final phase of the approach to the target altitude, and
introduces an (at best) harmless oscillation. This suggests that the I
term may be unnecessary in this application.</p>
<p>If the I (integrated error) term is dropped from the PID controller it
becomes a purely feed-forward, stateless function, which would be very
easy to implement.</p>
<p>The purpose of this notebook is to statistically characterise the PID
controller function as a stateless, feed-forward function. This function
could be compared to the simulated data to see what has been lost by
dropping the I term.</p>
<p>It is worth emphasizing that the PID controller being modelled is
completely fixed (i.e.it does not learn the control function and is not
adaptive to any changes) and is not guaranteed to be optimally tuned.</p>
<div id="read-data" class="section level1" number="1">
<h1><span class="header-section-number">1</span> Read data</h1>
<p>This notebook is based on the data generated by the simulation runs with
multiple target altitudes per run.</p>
<p>Read the data from the simulations and mathematically reconstruct the
values of the nodes not included in the input files.</p>
<pre class="r"><code># function to clip value to a range
clip &lt;- function(
  x, # numeric
  x_min, # numeric[1] - minimum output value
  x_max  # numeric[1] - maximum output value
) # value # numeric - x constrained to the range [x_min, x_max]
  {
  x %&gt;% pmax(x_min) %&gt;% pmin(x_max)
}

# function to extract a numeric parameter value from the file name
get_param_num &lt;- function(
  file, # character - vector of file names
  regexp # character[1] - regular expression for &quot;param=value&quot;
         # use a capture group to get the value part
) # value # numeric - vector of parameter values
{
  file %&gt;% str_match(regexp) %&gt;% 
      subset(select = 2) %&gt;% as.numeric()
}

# function to extract a sequence of numeric parameter values from the file name
get_param_num_seq &lt;- function(
  file, # character - vector of file names
  regexp # character[1] - regular expression for &quot;param=value&quot;
         # use a capture group to get the value part
) # value # character - character representation of a sequence, e.g. &quot;(1,2,3)&quot;
{
  file %&gt;% str_match(regexp) %&gt;% 
      subset(select = 2) %&gt;% 
    str_replace_all(c(&quot;^&quot; = &quot;(&quot;, &quot;_&quot; = &quot;,&quot;, &quot;$&quot; = &quot;)&quot;)) # reformat as sequence
}

# function to extract a logical parameter value from the file name
get_param_log &lt;- function(
  file, # character - vector of file names
  regexp # character[1] - regular expression for &quot;param=value&quot;
  # use a capture group to get the value part
  # value *must* be T or F
) # value # logical - vector of logical parameter values
{
  file %&gt;% str_match(regexp) %&gt;% 
    subset(select = 2) %&gt;% as.character() %&gt;% &quot;==&quot;(&quot;T&quot;)
}

# read the data
d_wide &lt;- fs::dir_ls(path = here::here(&quot;data&quot;, &quot;multiple_target&quot;), regexp = &quot;/targets=.*\\.csv$&quot;) %&gt;% # get file paths
  vroom::vroom(id = &quot;file&quot;) %&gt;% # read files
  dplyr::rename(k_tgt = target) %&gt;% # rename for consistency with single target data
  dplyr::mutate( # add extra columns
    file = file %&gt;% fs::path_ext_remove() %&gt;% fs::path_file(), # get file name
    # get parameters
    targets  = file %&gt;% get_param_num_seq(&quot;targets=([._0-9]+)_start=&quot;), # hacky
    k_start  = file %&gt;% get_param_num(&quot;start=([.0-9]+)&quot;), 
    sim_id   = paste(targets, k_start), # short ID for each simulation
    k_p      = file %&gt;% get_param_num(&quot;kp=([.0-9]+)&quot;),
    k_i      = file %&gt;% get_param_num(&quot;Ki=([.0-9]+)&quot;),
    # k_tgt    = file %&gt;% get_param_num(&quot;k_tgt=([.0-9]+)&quot;), # no longer needed
    k_windup = file %&gt;% get_param_num(&quot;k_windup=([.0-9]+)&quot;),
    uclip    = FALSE, # constant across all files
    dz0      = TRUE, # constant across all files
    # Deal with the fact that the interpretation of the imported u value
    # depends on the uclip parameter
    u_import = u, # keep a copy of the imported value to one side
    u = dplyr::if_else(uclip, # make u the &quot;correct&quot; value
                       u_import, 
                       clip(u_import, 0, 1)
                       ),
    # reconstruct the missing nodes
    i1 = k_tgt - z,
    i2 = i1 - dz,
    i3 = e * k_p,
    i9 = lag(ei, n = 1, default = 0), # initialised to zero
    i4 = e + i9,
    i5 = i4 %&gt;% clip(-k_windup, k_windup),
    i6 = ei * k_i,
    i7 = i3 + i6,
    i8 = i7 %&gt;% clip(0, 1)
  ) %&gt;% 
  # add time variable per file
  dplyr::group_by(file) %&gt;% 
  dplyr::mutate(t = 1:n()) %&gt;% 
  dplyr::ungroup()</code></pre>
<pre><code>Rows: 6000 Columns: 8</code></pre>
<pre><code>── Column specification ────────────────────────────────────────────────────────
Delimiter: &quot;,&quot;
dbl (7): time, target, z, dz, e, ei, u</code></pre>
<pre><code>
ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
<pre class="r"><code>dplyr::glimpse(d_wide)</code></pre>
<pre><code>Rows: 6,000
Columns: 27
$ file     &lt;chr&gt; &quot;targets=1_3_5_start=3_kp=0.20_Ki=3.00_k_windup=0.20&quot;, &quot;targe…
$ time     &lt;dbl&gt; 0.00, 0.01, 0.02, 0.03, 0.04, 0.05, 0.06, 0.07, 0.08, 0.09, 0…
$ k_tgt    &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…
$ z        &lt;dbl&gt; 3.000, 3.000, 3.003, 3.005, 3.006, 3.006, 3.005, 3.002, 2.999…
$ dz       &lt;dbl&gt; 0.000, 0.286, 0.188, 0.090, -0.008, -0.106, -0.204, -0.302, -…
$ e        &lt;dbl&gt; -2.000, -2.286, -2.191, -2.095, -1.998, -1.899, -1.800, -1.70…
$ ei       &lt;dbl&gt; -0.200, -0.200, -0.200, -0.200, -0.200, -0.200, -0.200, -0.20…
$ u        &lt;dbl&gt; 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000…
$ targets  &lt;chr&gt; &quot;(1,3,5)&quot;, &quot;(1,3,5)&quot;, &quot;(1,3,5)&quot;, &quot;(1,3,5)&quot;, &quot;(1,3,5)&quot;, &quot;(1,3,…
$ k_start  &lt;dbl&gt; 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3…
$ sim_id   &lt;chr&gt; &quot;(1,3,5) 3&quot;, &quot;(1,3,5) 3&quot;, &quot;(1,3,5) 3&quot;, &quot;(1,3,5) 3&quot;, &quot;(1,3,5) …
$ k_p      &lt;dbl&gt; 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0…
$ k_i      &lt;dbl&gt; 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3…
$ k_windup &lt;dbl&gt; 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0…
$ uclip    &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE…
$ dz0      &lt;lgl&gt; TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, T…
$ u_import &lt;dbl&gt; -1.000, -1.057, -1.038, -1.019, -1.000, -0.980, -0.960, -0.94…
$ i1       &lt;dbl&gt; -2.000, -2.000, -2.003, -2.005, -2.006, -2.006, -2.005, -2.00…
$ i2       &lt;dbl&gt; -2.000, -2.286, -2.191, -2.095, -1.998, -1.900, -1.801, -1.70…
$ i3       &lt;dbl&gt; -0.4000, -0.4572, -0.4382, -0.4190, -0.3996, -0.3798, -0.3600…
$ i9       &lt;dbl&gt; 0.000, -0.200, -0.200, -0.200, -0.200, -0.200, -0.200, -0.200…
$ i4       &lt;dbl&gt; -2.000, -2.486, -2.391, -2.295, -2.198, -2.099, -2.000, -1.90…
$ i5       &lt;dbl&gt; -0.200, -0.200, -0.200, -0.200, -0.200, -0.200, -0.200, -0.20…
$ i6       &lt;dbl&gt; -0.600, -0.600, -0.600, -0.600, -0.600, -0.600, -0.600, -0.60…
$ i7       &lt;dbl&gt; -1.0000, -1.0572, -1.0382, -1.0190, -0.9996, -0.9798, -0.9600…
$ i8       &lt;dbl&gt; 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.000…
$ t        &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18…</code></pre>
</div>
<div id="plot-the-data" class="section level1" number="2">
<h1><span class="header-section-number">2</span> Plot the data</h1>
<p>The altitude error (<span class="math inline">\(i1\)</span>) is a deterministic function of the altitude
(<span class="math inline">\(z\)</span>) and the altitude target (<span class="math inline">\(k_{tgt}\)</span>). The two inputs <span class="math inline">\(z\)</span> and
<span class="math inline">\(k_{tgt}\)</span> can be replaced with the single input <span class="math inline">\(i1\)</span>. This has the
advantage of meaning that there are only two inputs <span class="math inline">\(i1\)</span>, and <span class="math inline">\(dz\)</span>,
which can be represented on a plane.</p>
<p>Display the distribution of input values to the PID controller across
all simulation runs.</p>
<pre class="r"><code>d_wide %&gt;% 
  ggplot(aes(x = i1, y = dz)) +
  geom_abline(slope = 1, intercept = 0, colour = &quot;red&quot;) + # reference line
  geom_point(alpha = 0.1) +
  coord_equal()</code></pre>
<p><img src="figure/PID_task_analysis.Rmd/unnamed-chunk-2-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-unnamed-chunk-2-1">
Past versions of unnamed-chunk-2-1.png
</button>
</p>
<div id="fig-unnamed-chunk-2-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/rgayler/VSA_altitude_hold/blob/bb5f38666d053b04ca16cb2cc1df5cde39eb167f/docs/figure/PID_task_analysis.Rmd/unnamed-chunk-2-1.png" target="_blank">bb5f386</a>
</td>
<td>
Ross Gayler
</td>
<td>
2021-09-09
</td>
</tr>
<tr>
<td>
<a href="https://github.com/rgayler/VSA_altitude_hold/blob/e1e1d253442f62438abdb4eae5c70b6d79e18280/docs/figure/PID_task_analysis.Rmd/unnamed-chunk-2-1.png" target="_blank">e1e1d25</a>
</td>
<td>
Ross Gayler
</td>
<td>
2021-08-20
</td>
</tr>
</tbody>
</table>
</div>
</div>
<ul>
<li><p>The dark (because there are many overlapping points) diagonal line
corresponds to the final phase of all the trajectories where the
altitude error and vertical velocity both decrease to zero with any
approximately constant ratio between the two quantities.</p>
<ul>
<li>The ratio is 1:1. That is, the line corresponds to
<span class="math inline">\(i2 (\triangleq i1n- dz) = 0\)</span>.</li>
<li>The central diagonal line deviates from <span class="math inline">\(i2 = 0\)</span> for
<span class="math inline">\(dz \lt -2.5\)</span>. This appears to be due to slight overshoot of the
initial trajectories leading into the diagonal.</li>
</ul></li>
<li><p>The light, approximately vertical curves correspond to the initial
phase of all the trajectories, where the multicopter is either
climbing at full power or dropping at zero power.</p></li>
</ul>
<p>Rotate the axes by 45 degrees to make the diagonal axis-parallel in the
new coordinates.</p>
<pre class="r"><code>d_wide %&gt;% 
  ggplot(aes( x = i1 - dz, y = (i1 + dz)/2)) +
  geom_point(alpha = 0.1) +
  coord_equal()</code></pre>
<p><img src="figure/PID_task_analysis.Rmd/unnamed-chunk-3-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-unnamed-chunk-3-1">
Past versions of unnamed-chunk-3-1.png
</button>
</p>
<div id="fig-unnamed-chunk-3-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/rgayler/VSA_altitude_hold/blob/bb5f38666d053b04ca16cb2cc1df5cde39eb167f/docs/figure/PID_task_analysis.Rmd/unnamed-chunk-3-1.png" target="_blank">bb5f386</a>
</td>
<td>
Ross Gayler
</td>
<td>
2021-09-09
</td>
</tr>
<tr>
<td>
<a href="https://github.com/rgayler/VSA_altitude_hold/blob/e1e1d253442f62438abdb4eae5c70b6d79e18280/docs/figure/PID_task_analysis.Rmd/unnamed-chunk-3-1.png" target="_blank">e1e1d25</a>
</td>
<td>
Ross Gayler
</td>
<td>
2021-08-20
</td>
</tr>
</tbody>
</table>
</div>
</div>
<ul>
<li>The x axis is equivalent to <span class="math inline">\(i2\)</span>.</li>
</ul>
<p>Add the clipped motor command to the plot.</p>
<p>The clipped motor command lies in the range <span class="math inline">\([0, 1]\)</span> and 0.524 is the
command level for hovering. It will be useful to rescale the motor
command level so that zero corresponds to hover and the magnitude of the
maximum deviation from hover is one.</p>
<pre class="r"><code>p &lt;- d_wide %&gt;% 
  dplyr::mutate(i8_scl = (i8 - 0.524) / 0.524) %&gt;% 
  ggplot(aes(group = paste(sim_id, k_tgt))) +
  scale_color_viridis_c()

p +
  geom_point(aes(x = i1 - dz, y = (i1 + dz)/2, 
                 size = abs(i8_scl), colour = i8_scl),
             alpha = 0.5) +
  geom_path(aes(x = i1 - dz, y = (i1 + dz)/2), alpha = 0.2)</code></pre>
<p><img src="figure/PID_task_analysis.Rmd/unnamed-chunk-4-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-unnamed-chunk-4-1">
Past versions of unnamed-chunk-4-1.png
</button>
</p>
<div id="fig-unnamed-chunk-4-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/rgayler/VSA_altitude_hold/blob/bb5f38666d053b04ca16cb2cc1df5cde39eb167f/docs/figure/PID_task_analysis.Rmd/unnamed-chunk-4-1.png" target="_blank">bb5f386</a>
</td>
<td>
Ross Gayler
</td>
<td>
2021-09-09
</td>
</tr>
<tr>
<td>
<a href="https://github.com/rgayler/VSA_altitude_hold/blob/e1e1d253442f62438abdb4eae5c70b6d79e18280/docs/figure/PID_task_analysis.Rmd/unnamed-chunk-4-1.png" target="_blank">e1e1d25</a>
</td>
<td>
Ross Gayler
</td>
<td>
2021-08-20
</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Remember, <span class="math inline">\(e \triangleq i2 \triangleq i1 - dz\)</span>. <span class="math inline">\(e\)</span> is the “error”,
which should be interpreted as the predicted altitude error in one
second, assuming that the multicopter maintains the current vertical
velocity.</p>
<p>This graph is a plan view, looking down on the surface to be modelled as
a function of the input variables.</p>
<ul>
<li>When <span class="math inline">\(e \lt 0\)</span> (the left half-plane), the motor command <span class="math inline">\(i8\)</span> is
minimum.</li>
<li>When <span class="math inline">\(e \gt 0\)</span> (the right half-plane), the motor command <span class="math inline">\(i8\)</span> is
(approximately) maximum.</li>
<li>When <span class="math inline">\(e \approx 0\)</span> (the final phase of the trajectories) the motor
command decreases as the <span class="math inline">\(y\)</span> axis increases.</li>
</ul>
<pre class="r"><code>p +
  geom_point(aes(x = i1 - dz, y = i8_scl, 
                 size = abs(i8_scl), colour = i8_scl), 
             alpha = 0.5) +
  geom_path(aes(x = i1 - dz, y = i8_scl), alpha = 0.2)</code></pre>
<p><img src="figure/PID_task_analysis.Rmd/unnamed-chunk-5-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-unnamed-chunk-5-1">
Past versions of unnamed-chunk-5-1.png
</button>
</p>
<div id="fig-unnamed-chunk-5-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/rgayler/VSA_altitude_hold/blob/0b43b6e500bfa8a3a777e0e9efc2ded734d352ba/docs/figure/PID_task_analysis.Rmd/unnamed-chunk-5-1.png" target="_blank">0b43b6e</a>
</td>
<td>
Ross Gayler
</td>
<td>
2021-09-09
</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>This graph is a side view of the surface to be modelled. The <span class="math inline">\(x\)</span> axis
corresponds to <span class="math inline">\(e\)</span> and the orthogonal input (<span class="math inline">\((i1 + dz)/2)\)</span>) is
collapsed over.</p>
<p>To a first approximation:</p>
<ul>
<li><p>When <span class="math inline">\(e \lt 0\)</span> (the left half-plane), the motor command <span class="math inline">\(i8\)</span> is
minimum.</p></li>
<li><p>When <span class="math inline">\(e \gt 0\)</span> (the right half-plane), the motor command <span class="math inline">\(i8\)</span> is
(approximately) maximum.</p>
<ul>
<li>The aproximation here is that as <span class="math inline">\(e\)</span> approaches zero from above,
when it gets sufficiently close to zero the motor command scales
down from the maximum.</li>
</ul></li>
</ul>
<pre class="r"><code>p +
  geom_abline(slope = -1/20, intercept = 0, colour = &quot;red&quot;) + # reference line
  geom_point(aes(x = (i1 + dz)/2, y = i8_scl, 
                 size = abs(i8_scl), colour = i8_scl), 
             alpha = 0.5) +
  geom_path(aes(x = (i1 + dz)/2, y = i8_scl), alpha = 0.2)</code></pre>
<p><img src="figure/PID_task_analysis.Rmd/unnamed-chunk-6-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-unnamed-chunk-6-1">
Past versions of unnamed-chunk-6-1.png
</button>
</p>
<div id="fig-unnamed-chunk-6-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/rgayler/VSA_altitude_hold/blob/0b43b6e500bfa8a3a777e0e9efc2ded734d352ba/docs/figure/PID_task_analysis.Rmd/unnamed-chunk-6-1.png" target="_blank">0b43b6e</a>
</td>
<td>
Ross Gayler
</td>
<td>
2021-09-09
</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>This graph is the other side view of the surface to be modelled. The <span class="math inline">\(x\)</span>
axis corresponds to (<span class="math inline">\((i1 + dz)/2)\)</span>) and the orthogonal input <span class="math inline">\(e\)</span> is
collapsed over.</p>
<ul>
<li>Ignoring the overshoots and oscillations, when the trajectories are
in the final phase (<span class="math inline">\(e \approx 0\)</span>), the motor command is a linear
function of <span class="math inline">\((i1 + dz)/2\)</span>.</li>
<li>The trajectories “drop” suddenly from the initial phase to the final
phase.</li>
</ul>
<div id="summary" class="section level2" number="2.1">
<h2><span class="header-section-number">2.1</span> Summary</h2>
<ul>
<li>Ignoring the overshoots and oscillations the overall shape of the
function surface is not very complex (e.g. it’s not fractal).</li>
<li>The surface does involve an interaction. (It can’t be modelled as
the sum of axis-parallel effects.)</li>
<li>There are sharp discontinuities.</li>
<li>The data from the initial phases is rather sparsely distributed over
the input plane. This means that “learning” the function will
require some strong biases to paper over the gaps.</li>
</ul>
</div>
</div>
<div id="model-the-data" class="section level1" number="3">
<h1><span class="header-section-number">3</span> Model the data</h1>
<p>Fitting a smoothing spline regression to the data, it is very helpful if
the predictor variables capture the major features of the data (to
minimise the work done by the smoothing). Using an appropriately crafted
set of predictor variables provides a bias to the functions that can be
learned from the data.</p>
<p>I will use <a href="https://en.wikipedia.org/wiki/Generalized_additive_model">Generalised Additive Models
(GAM)</a> as the
modelling technique here.</p>
<div id="without-feature-engineering" class="section level2" number="3.1">
<h2><span class="header-section-number">3.1</span> Without feature engineering</h2>
<p>Show what a GAM can do without any problem-specific feature engineering.</p>
<p>Fit marginal smooths first to help build up intuition.</p>
<div id="e-term" class="section level3" number="3.1.1">
<h3><span class="header-section-number">3.1.1</span> <span class="math inline">\(e\)</span> term</h3>
<p>Remember that <span class="math inline">\(u \triangleq i8\)</span>.</p>
<p>Model <span class="math inline">\(u\)</span> as a function of <span class="math inline">\(e\)</span>.</p>
<pre class="r"><code>fit1 &lt;- mgcv::gam(u ~ s(e, bs =  &quot;ad&quot;), data = d_wide)
summary(fit1)</code></pre>
<pre><code>
Family: gaussian 
Link function: identity 

Formula:
u ~ s(e, bs = &quot;ad&quot;)

Parametric coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) 0.507238   0.000639   793.8   &lt;2e-16 ***
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1

Approximate significance of smooth terms:
      edf Ref.df    F p-value    
s(e) 18.9  21.57 1673  &lt;2e-16 ***
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1

R-sq.(adj) =  0.857   Deviance explained = 85.8%
GCV = 0.0024582  Scale est. = 0.0024501  n = 6000</code></pre>
<pre class="r"><code>plot(fit1)</code></pre>
<p><img src="figure/PID_task_analysis.Rmd/unnamed-chunk-7-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-unnamed-chunk-7-1">
Past versions of unnamed-chunk-7-1.png
</button>
</p>
<div id="fig-unnamed-chunk-7-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/rgayler/VSA_altitude_hold/blob/470fc770283e814b51897e54d33130a4d0eeb1fc/docs/figure/PID_task_analysis.Rmd/unnamed-chunk-7-1.png" target="_blank">470fc77</a>
</td>
<td>
Ross Gayler
</td>
<td>
2021-09-10
</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>This uses an adaptive smoother (<code>bs = "ad"</code>) so that the degrees of
freedom are concentrated where the curvature is highest.</p>
<p>The scaling on the <span class="math inline">\(y\)</span> axis of the plot is arbitrary.</p>
<ul>
<li>The smooth picks up the strong dependency of motor command <span class="math inline">\(u\)</span> on
the sign of the error <span class="math inline">\(e\)</span>.</li>
<li>~86% deviance explained. (Most of the variance of the motor command
is explained by the <span class="math inline">\(e\)</span> term.)</li>
</ul>
</div>
<div id="e_orth-term" class="section level3" number="3.1.2">
<h3><span class="header-section-number">3.1.2</span> <span class="math inline">\(e_{orth}\)</span> term</h3>
<p>I will use <span class="math inline">\(e_{orth}\)</span> as a convenience to refer to <span class="math inline">\((i1 + dz)/2\)</span> because
it is orthogonal to <span class="math inline">\(e\)</span>.</p>
<p>Model <span class="math inline">\(u\)</span> as a function of <span class="math inline">\(e_{orth}\)</span>.</p>
<pre class="r"><code>fit2 &lt;- mgcv::gam(u ~ s(I((i1 + dz)/2), bs =  &quot;ad&quot;), data = d_wide)
summary(fit2)</code></pre>
<pre><code>
Family: gaussian 
Link function: identity 

Formula:
u ~ s(I((i1 + dz)/2), bs = &quot;ad&quot;)

Parametric coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) 0.507238   0.001555   326.1   &lt;2e-16 ***
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1

Approximate significance of smooth terms:
                    edf Ref.df     F p-value    
s(I((i1 + dz)/2)) 12.61  15.29 72.03  &lt;2e-16 ***
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1

R-sq.(adj) =  0.155   Deviance explained = 15.7%
GCV = 0.014548  Scale est. = 0.014515  n = 6000</code></pre>
<pre class="r"><code>plot(fit2)</code></pre>
<p><img src="figure/PID_task_analysis.Rmd/unnamed-chunk-8-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-unnamed-chunk-8-1">
Past versions of unnamed-chunk-8-1.png
</button>
</p>
<div id="fig-unnamed-chunk-8-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/rgayler/VSA_altitude_hold/blob/470fc770283e814b51897e54d33130a4d0eeb1fc/docs/figure/PID_task_analysis.Rmd/unnamed-chunk-8-1.png" target="_blank">470fc77</a>
</td>
<td>
Ross Gayler
</td>
<td>
2021-09-10
</td>
</tr>
</tbody>
</table>
</div>
</div>
<ul>
<li>The central, slightly negatively sloped section from -2 to +2
captures the relation ship to <span class="math inline">\(u\)</span> in the terminal phases of the
trajectories (<span class="math inline">\(e \approx 0\)</span>).</li>
<li>Outside that range, most of the observations are in the initial
phases of the trajectories, so tend to be at extreme values of <span class="math inline">\(u\)</span>.</li>
<li>~16% deviance explained. (<span class="math inline">\(e_{orth}\)</span> only explains a small fraction
of of the variance of the motor command, and even this might be
dominated by the points outside the terminal phases of the
trajectories.)</li>
</ul>
<p>Fit the model on a subset of the observations corresponding to the
terminal phases.</p>
<pre class="r"><code>fit3 &lt;- mgcv::gam(u ~ s(I((i1 + dz)/2), bs =  &quot;cr&quot;), data = d_wide, 
                  subset = abs(e) &lt; 0.1)
plot(fit3)</code></pre>
<p><img src="figure/PID_task_analysis.Rmd/unnamed-chunk-9-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-unnamed-chunk-9-1">
Past versions of unnamed-chunk-9-1.png
</button>
</p>
<div id="fig-unnamed-chunk-9-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/rgayler/VSA_altitude_hold/blob/470fc770283e814b51897e54d33130a4d0eeb1fc/docs/figure/PID_task_analysis.Rmd/unnamed-chunk-9-1.png" target="_blank">470fc77</a>
</td>
<td>
Ross Gayler
</td>
<td>
2021-09-10
</td>
</tr>
</tbody>
</table>
</div>
</div>
<ul>
<li>The negative slope in the terminal phases is clear. (The
nonmonotonicity at the left end is due to a small number of outlier
points).</li>
</ul>
</div>
<div id="joint-smooth" class="section level3" number="3.1.3">
<h3><span class="header-section-number">3.1.3</span> Joint smooth</h3>
<p>Fit a smooth that is a function of the joint values of <span class="math inline">\(e\)</span> and
<span class="math inline">\(e_{orth}\)</span>.</p>
<p>Use a thin-plate smoothing basis (<code>bs = "tp"</code>).</p>
<pre class="r"><code>fit4 &lt;- mgcv::gam(u ~ s(e, I((i1 + dz)/2), bs =  &quot;tp&quot;), data = d_wide)
summary(fit4)</code></pre>
<pre><code>
Family: gaussian 
Link function: identity 

Formula:
u ~ s(e, I((i1 + dz)/2), bs = &quot;tp&quot;)

Parametric coefficients:
             Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) 0.5072383  0.0005842   868.3   &lt;2e-16 ***
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1

Approximate significance of smooth terms:
                      edf Ref.df    F p-value    
s(e,I((i1 + dz)/2)) 28.84     29 1529  &lt;2e-16 ***
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1

R-sq.(adj) =  0.881   Deviance explained = 88.1%
GCV = 0.0020577  Scale est. = 0.0020475  n = 6000</code></pre>
<pre class="r"><code>plot(fit4, se = FALSE, scheme = 2)</code></pre>
<p><img src="figure/PID_task_analysis.Rmd/unnamed-chunk-10-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-unnamed-chunk-10-1">
Past versions of unnamed-chunk-10-1.png
</button>
</p>
<div id="fig-unnamed-chunk-10-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/rgayler/VSA_altitude_hold/blob/470fc770283e814b51897e54d33130a4d0eeb1fc/docs/figure/PID_task_analysis.Rmd/unnamed-chunk-10-1.png" target="_blank">470fc77</a>
</td>
<td>
Ross Gayler
</td>
<td>
2021-09-10
</td>
</tr>
</tbody>
</table>
</div>
</div>
<pre class="r"><code>plot(fit4, se = FALSE, scheme = 1, theta = -30)</code></pre>
<p><img src="figure/PID_task_analysis.Rmd/unnamed-chunk-10-2.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-unnamed-chunk-10-2">
Past versions of unnamed-chunk-10-2.png
</button>
</p>
<div id="fig-unnamed-chunk-10-2" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/rgayler/VSA_altitude_hold/blob/470fc770283e814b51897e54d33130a4d0eeb1fc/docs/figure/PID_task_analysis.Rmd/unnamed-chunk-10-2.png" target="_blank">470fc77</a>
</td>
<td>
Ross Gayler
</td>
<td>
2021-09-10
</td>
</tr>
</tbody>
</table>
</div>
</div>
<ul>
<li>The smooth captures the strong dependency between <span class="math inline">\(u\)</span> and <span class="math inline">\(e\)</span>.</li>
<li>The smooth fails to capture the relationship with <span class="math inline">\(e_{orth}\)</span> at
<span class="math inline">\(e \approx 0\)</span>.</li>
<li>~88% deviance explained. (This is only a slight increase relative
to modelling only the <span class="math inline">\(e\)</span> term.)</li>
</ul>
</div>
</div>
<div id="with-feature-engineering" class="section level2" number="3.2">
<h2><span class="header-section-number">3.2</span> With feature engineering</h2>
<p>Model the function, this time using features designed to capture the
major aspects of the shape of the surface. Such features constitute a
strong bias on the set of functions that can be learned from the data.
They also provide a mechanism for extrapolating outside the support of
the data.</p>
<div id="e-terms" class="section level3" number="3.2.1">
<h3><span class="header-section-number">3.2.1</span> <span class="math inline">\(e\)</span> terms</h3>
<p>The previous analyses showed that the surface should be partitioned into
three regions along <span class="math inline">\(e\)</span>.</p>
<ul>
<li>When <span class="math inline">\(e &lt; 0\)</span> then <span class="math inline">\(u\)</span> is constant at 0 (initial phase of
trajectories).</li>
<li>When <span class="math inline">\(e &gt; 0\)</span> then <span class="math inline">\(u\)</span> is roughly constant at (initial phase of
trajectories).</li>
<li>When <span class="math inline">\(e = 0\)</span> then <span class="math inline">\(u\)</span> is roughly a linear function of <span class="math inline">\(e_{orth}\)</span>
(terminal phase of trajectories).</li>
</ul>
<p>The <span class="math inline">\(e = 0\)</span> class is infinitesimally narrow, which is likely to cause
problems in a practical system. Consequently, I will make that class a
small finite width.</p>
<pre class="r"><code>e_fuzz &lt;- 0.1 # half width of central strip
fit5 &lt;- mgcv::gam(u ~ I(e &gt;= e_fuzz) + I(abs(e) &lt; e_fuzz), data = d_wide)
summary(fit5)</code></pre>
<pre><code>
Family: gaussian 
Link function: identity 

Formula:
u ~ I(e &gt;= e_fuzz) + I(abs(e) &lt; e_fuzz)

Parametric coefficients:
                        Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)            6.661e-16  3.917e-03     0.0        1    
I(e &gt;= e_fuzz)TRUE     7.351e-01  5.177e-03   142.0   &lt;2e-16 ***
I(abs(e) &lt; e_fuzz)TRUE 5.164e-01  4.005e-03   128.9   &lt;2e-16 ***
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1


R-sq.(adj) =  0.781   Deviance explained = 78.1%
GCV = 0.0037613  Scale est. = 0.0037594  n = 6000</code></pre>
<p>Scoring out regions by eye from the regression coefficients (this is a
step function):</p>
<ul>
<li><p><span class="math inline">\(e \le -0.1\)</span> - <span class="math inline">\(u \approx 0\)</span></p></li>
<li><p><span class="math inline">\(-0.1 \lt e \lt +0.1\)</span> - <span class="math inline">\(u \approx 0.52\)</span></p></li>
<li><p><span class="math inline">\(e \ge +0.1\)</span> - <span class="math inline">\(u \approx 0.74\)</span></p></li>
<li><p>~78% deviance explained (compared to 86% for the smoothing spline
model).</p></li>
</ul>
<p>Look at the plot of <code>fit1</code>. The smoothing spline model has a slope
between $e  and <span class="math inline">\(e \approx 2\)</span>. The current model (<code>fit5</code>)
can’t account for this slope, which is why the goodness of fit is
reduced.</p>
<p>However, it’s not clear that the slope is actually needed for the
controller to work well, so I’ll ignore it.</p>
</div>
<div id="e_orth-term-1" class="section level3" number="3.2.2">
<h3><span class="header-section-number">3.2.2</span> <span class="math inline">\(e_{orth}\)</span> term</h3>
<p>Now add the <span class="math inline">\(e_{orth}\)</span> into the model.</p>
<p><span class="math inline">\(u\)</span> is a linear function of <span class="math inline">\(e_{orth}\)</span> when <span class="math inline">\(e \approx 0\)</span> and irrelevant
elsewhere, which requires an interaction of <span class="math inline">\(e_{orth}\)</span> with <span class="math inline">\(e\)</span>.</p>
<pre class="r"><code>fit6 &lt;- mgcv::gam(
  u ~ I(e &gt;= e_fuzz) + I(abs(e) &lt; e_fuzz) +
    I(as.numeric(abs(e) &lt; e_fuzz) * (i1 + dz)/2), 
  data = d_wide)
summary(fit6)</code></pre>
<pre><code>
Family: gaussian 
Link function: identity 

Formula:
u ~ I(e &gt;= e_fuzz) + I(abs(e) &lt; e_fuzz) + I(as.numeric(abs(e) &lt; 
    e_fuzz) * (i1 + dz)/2)

Parametric coefficients:
                                               Estimate Std. Error t value
(Intercept)                                  -3.886e-16  3.433e-03    0.00
I(e &gt;= e_fuzz)TRUE                            7.351e-01  4.537e-03  162.02
I(abs(e) &lt; e_fuzz)TRUE                        5.214e-01  3.511e-03  148.50
I(as.numeric(abs(e) &lt; e_fuzz) * (i1 + dz)/2) -2.665e-02  6.258e-04  -42.59
                                             Pr(&gt;|t|)    
(Intercept)                                         1    
I(e &gt;= e_fuzz)TRUE                             &lt;2e-16 ***
I(abs(e) &lt; e_fuzz)TRUE                         &lt;2e-16 ***
I(as.numeric(abs(e) &lt; e_fuzz) * (i1 + dz)/2)   &lt;2e-16 ***
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1


R-sq.(adj) =  0.832   Deviance explained = 83.2%
GCV = 0.0028886  Scale est. = 0.0028866  n = 6000</code></pre>
<p>Scoring out regions by eye from the regression coefficients (this is a
step function):</p>
<ul>
<li><p><span class="math inline">\(e \le -0.1\)</span> - <span class="math inline">\(u \approx 0\)</span></p></li>
<li><p><span class="math inline">\(-0.1 \lt e \lt +0.1\)</span> - <span class="math inline">\(u \approx -0.027 e_{orth} + 0.52\)</span></p></li>
<li><p><span class="math inline">\(e \ge +0.1\)</span> - <span class="math inline">\(u \approx 0.74\)</span></p></li>
<li><p>~83% deviance explained (compared to 88% for the bivariate
smoothing spline model).</p></li>
</ul>
<p>This model seems to pick up the major features of the surface.</p>
<p>In a future analysis I will use the construction of these terms to guide
the placement of the knots in VSA representations of scalars.</p>
<br>
<p>
<button type="button" class="btn btn-default btn-workflowr btn-workflowr-sessioninfo" data-toggle="collapse" data-target="#workflowr-sessioninfo" style="display: block;">
<span class="glyphicon glyphicon-wrench" aria-hidden="true"></span>
Session information
</button>
</p>
<div id="workflowr-sessioninfo" class="collapse">
<pre class="r"><code>sessionInfo()</code></pre>
<pre><code>R version 4.1.1 (2021-08-10)
Platform: x86_64-pc-linux-gnu (64-bit)
Running under: Ubuntu 21.04

Matrix products: default
BLAS:   /usr/lib/x86_64-linux-gnu/blas/libblas.so.3.9.0
LAPACK: /usr/lib/x86_64-linux-gnu/lapack/liblapack.so.3.9.0

locale:
 [1] LC_CTYPE=en_AU.UTF-8       LC_NUMERIC=C              
 [3] LC_TIME=en_AU.UTF-8        LC_COLLATE=en_AU.UTF-8    
 [5] LC_MONETARY=en_AU.UTF-8    LC_MESSAGES=en_AU.UTF-8   
 [7] LC_PAPER=en_AU.UTF-8       LC_NAME=C                 
 [9] LC_ADDRESS=C               LC_TELEPHONE=C            
[11] LC_MEASUREMENT=en_AU.UTF-8 LC_IDENTIFICATION=C       

attached base packages:
[1] stats     graphics  grDevices datasets  utils     methods   base     

other attached packages:
 [1] tibble_3.1.4       Matrix_1.3-4       purrr_0.3.4        DiagrammeR_1.0.6.1
 [5] mgcv_1.8-36        nlme_3.1-153       ggplot2_3.3.5      stringr_1.4.0     
 [9] dplyr_1.0.7        vroom_1.5.4        here_1.0.1         fs_1.5.0          

loaded via a namespace (and not attached):
 [1] tidyselect_1.1.1   xfun_0.25          splines_4.1.1      lattice_0.20-44   
 [5] colorspace_2.0-2   vctrs_0.3.8        generics_0.1.0     viridisLite_0.4.0 
 [9] htmltools_0.5.2    yaml_2.2.1         utf8_1.2.2         rlang_0.4.11      
[13] later_1.3.0        pillar_1.6.2       glue_1.4.2         withr_2.4.2       
[17] bit64_4.0.5        RColorBrewer_1.1-2 lifecycle_1.0.0    munsell_0.5.0     
[21] gtable_0.3.0       workflowr_1.6.2    visNetwork_2.0.9   htmlwidgets_1.5.4 
[25] evaluate_0.14      labeling_0.4.2     knitr_1.34         tzdb_0.1.2        
[29] fastmap_1.1.0      httpuv_1.6.3       parallel_4.1.1     fansi_0.5.0       
[33] highr_0.9          Rcpp_1.0.7         renv_0.14.0        promises_1.2.0.1  
[37] scales_1.1.1       jsonlite_1.7.2     farver_2.1.0       bit_4.0.4         
[41] digest_0.6.27      stringi_1.7.4      bookdown_0.24      rprojroot_2.0.2   
[45] grid_4.1.1         cli_3.0.1          tools_4.1.1        magrittr_2.0.1    
[49] crayon_1.4.1       whisker_0.4        pkgconfig_2.0.3    ellipsis_0.3.2    
[53] rstudioapi_0.13    rmarkdown_2.10     R6_2.5.1           git2r_0.28.0      
[57] compiler_4.1.1    </code></pre>
</div>
</div>
</div>
</div>


<!-- Adjust MathJax settings so that all math formulae are shown using
TeX fonts only; see
http://docs.mathjax.org/en/latest/configuration.html.  This will make
the presentation more consistent at the cost of the webpage sometimes
taking slightly longer to load. Note that this only works because the
footer is added to webpages before the MathJax javascript. -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    "HTML-CSS": { availableFonts: ["TeX"] }
  });
</script>




</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3,h4,h5",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
